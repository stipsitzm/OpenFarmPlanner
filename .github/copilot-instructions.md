# CSA Farm Planner

This is a full-stack web application for managing CSA (Community Supported Agriculture) farm operations. It helps farm managers organize their farm layout (locations, fields, beds), manage crop varieties (cultures), plan planting schedules with automatic harvest date calculations based on crop characteristics, and track farm tasks and activities. The application is designed for small to medium-sized CSA farms looking to streamline their planning and operations.

## Tech Stack

### Backend

- **Python 3.12+**: Programming language
- **Django 5.2.9**: Web framework for building the REST API
- **Django REST Framework 3.16**: Provides RESTful API endpoints with serialization
- **django-cors-headers 4.9.0**: CORS support for frontend-backend communication
- **SQLite**: Database (development), can be migrated to PostgreSQL for production
- **PDM (Python Dependency Manager)**: Modern package manager for dependency management
  - Uses PEP 621 compliant `pyproject.toml`
  - Auto-manages virtual environment in `.venv/`
  - PDM scripts for common Django commands

### Frontend

- **Vite 7.2**: Fast build tool and development server
- **React 19**: UI library for building components
- **TypeScript 5.9**: Type-safe JavaScript
- **React Router 7.9**: Client-side routing
- **Axios 1.13**: HTTP client for API requests
- **Vitest 4.0**: Testing framework
- **ESLint**: Code linting
- **React Testing Library**: Component testing utilities

### Testing

- **Backend**: Django's built-in unittest framework
- **Frontend**: Vitest with React Testing Library for component tests
- **E2E**: Not yet implemented (future consideration: Playwright)

## Project and Code Guidelines

### Python (Backend)

- **Always use type hints** for function parameters and return values
- **Always use docstrings** for all functions, classes, and modules
  - Use Google-style docstrings format
  - Include: description, Args, Returns, Raises sections where applicable
- Follow PEP 8 style guidelines
- Use Django's built-in features and ORM best practices
- Model methods should be well-documented with docstrings
- API views should use DRF's ViewSets for consistency
- Keep serializers close to models for clarity
- Unit tests are required for models and API endpoints
- Security: Follow Django security best practices (CSRF, SQL injection prevention, etc.)

### TypeScript (Frontend)

- **Always use TypeScript** - no plain JavaScript files
- **Always use explicit type annotations** for function parameters and return values
- Use interfaces for data structures (e.g., API response types)
- Components should have proper prop types defined
- Use React hooks appropriately (useState, useEffect, etc.)
- Keep components focused and single-responsibility
- CSS classes over inline styles (use centralized App.css)
- Use semantic HTML
- API calls should go through the centralized client in `src/api/client.ts`
- Unit tests required for components and utilities

### General Guidelines

- RESTful API design principles
- Consistent error handling
- Meaningful variable and function names
- Comments for complex logic only (code should be self-documenting)
- No dead code or commented-out code in commits
- Git commit messages should be clear and descriptive

## Project Structure

```
CSA_FarmPlanner/
├── backend/                      # Django REST API backend
│   ├── config/                   # Django project configuration
│   │   ├── settings.py          # Django settings
│   │   ├── urls.py              # Root URL configuration
│   │   ├── wsgi.py              # WSGI configuration
│   │   └── asgi.py              # ASGI configuration
│   ├── farm/                     # Main Django app
│   │   ├── models.py            # Database models (Location, Field, Bed, Culture, PlantingPlan, Task)
│   │   ├── serializers.py       # DRF serializers for API
│   │   ├── views.py             # DRF ViewSets for CRUD operations
│   │   ├── admin.py             # Django admin configuration
│   │   ├── urls.py              # App-level URL routing
│   │   ├── tests.py             # Unit tests for models and API
│   │   └── migrations/          # Database migrations
│   ├── manage.py                # Django management script
│   ├── pyproject.toml           # PDM project configuration with dependencies
│   ├── .venv/                   # Virtual environment (auto-generated by PDM, gitignored)
│   ├── .gitignore               # Git ignore patterns for Python/Django
│   └── README.md                # Backend-specific documentation
│
├── frontend/                     # React TypeScript frontend
│   ├── src/
│   │   ├── api/                 # API client and type definitions
│   │   │   └── client.ts        # Axios-based API client with typed interfaces
│   │   ├── pages/               # Page components
│   │   │   ├── Home.tsx         # Landing page with quick links
│   │   │   ├── Cultures.tsx     # Culture list/create page
│   │   │   ├── Beds.tsx         # Bed list/create page
│   │   │   └── PlantingPlans.tsx # Planting plan list/create page
│   │   ├── components/          # Reusable components (currently empty, future use)
│   │   ├── __tests__/           # Test files
│   │   │   ├── App.test.tsx
│   │   │   ├── Home.test.tsx
│   │   │   └── api.test.ts
│   │   ├── App.tsx              # Main app component with routing
│   │   ├── App.css              # Centralized styles
│   │   ├── index.css            # Global styles
│   │   ├── main.tsx             # Application entry point
│   │   └── setupTests.ts        # Test configuration
│   ├── public/                  # Static assets
│   ├── package.json             # NPM dependencies and scripts
│   ├── tsconfig.json            # TypeScript configuration
│   ├── vite.config.ts           # Vite configuration
│   ├── eslint.config.js         # ESLint configuration
│   ├── .gitignore               # Git ignore patterns for Node/React
│   └── README.md                # Frontend-specific documentation (auto-generated)
│
├── README.md                     # Main project documentation
└── .gitignore                    # Root-level git ignore
```

## Key Architectural Patterns

### Backend

- **Models**: Django ORM models define the database schema
  - Location → Field → Bed hierarchy for farm organization
  - Culture stores crop information with `days_to_harvest`
  - PlantingPlan has auto-calculated `harvest_date` via model save() override
  - Task optionally links to PlantingPlan
- **Serializers**: DRF serializers handle JSON serialization/deserialization
  - Read-only fields for related object names (e.g., `culture_name`, `bed_name`)
  - `harvest_date` is read-only in PlantingPlanSerializer
- **Views**: DRF ViewSets provide standard CRUD operations
  - All use `ModelViewSet` for consistency
  - Pagination enabled (100 items per page)
- **Admin**: Custom admin classes with list_display, search, and filters
- **URLs**: RESTful routes using DRF's DefaultRouter

### Frontend

- **API Client**: Centralized in `src/api/client.ts`
  - Typed interfaces for all API responses
  - Axios instance with base URL configuration
  - Separate API objects for each resource (cultureAPI, bedAPI, etc.)
- **Pages**: One page per main resource (Cultures, Beds, PlantingPlans)
  - List view with data table
  - Inline create form (toggle on/off)
  - Delete functionality
  - Error handling with user-friendly messages
- **Routing**: React Router with navigation bar
- **Styling**: CSS classes in App.css, no inline styles

## Resources and Scripts

### Backend Scripts (via PDM)

All scripts are defined in `backend/pyproject.toml` under `[tool.pdm.scripts]`:

- `pdm install` - Install all dependencies and create/update virtual environment
- `pdm add <package>` - Add a new dependency
- `pdm run migrate` - Apply database migrations
- `pdm run makemigrations` - Create new migrations from model changes
- `pdm run runserver` - Start Django development server (http://localhost:8000)
- `pdm run test` - Run backend unit tests
- `pdm run createsuperuser` - Create Django admin superuser
- `pdm run shell` - Open Django shell
- `pdm run collectstatic` - Collect static files for production

### Frontend Scripts (via npm)

Defined in `frontend/package.json`:

- `npm install` - Install all dependencies
- `npm run dev` - Start Vite development server (http://localhost:5173)
- `npm run build` - Build for production
- `npm run test` - Run tests once
- `npm run test:watch` - Run tests in watch mode
- `npm run lint` - Run ESLint
- `npm run preview` - Preview production build locally

### Development Workflow

1. **First-time setup**:
   ```bash
   # Backend
   cd backend
   pdm install
   pdm run migrate
   pdm run createsuperuser  # Optional
   
   # Frontend
   cd frontend
   npm install
   ```

2. **Starting development servers**:
   ```bash
   # Terminal 1 - Backend
   cd backend
   pdm run runserver
   
   # Terminal 2 - Frontend
   cd frontend
   npm run dev
   ```

3. **Running tests**:
   ```bash
   # Backend tests
   cd backend
   pdm run test
   
   # Frontend tests
   cd frontend
   npm test
   ```

4. **Making model changes**:
   ```bash
   cd backend
   # Edit models in farm/models.py
   pdm run makemigrations
   pdm run migrate
   pdm run test  # Verify tests still pass
   ```

## API Endpoints

All API endpoints are under `/api/`:

- `/api/locations/` - CRUD for farm locations
- `/api/fields/` - CRUD for fields within locations
- `/api/beds/` - CRUD for beds within fields
- `/api/cultures/` - CRUD for crop varieties
- `/api/planting-plans/` - CRUD for planting schedules
- `/api/tasks/` - CRUD for farm tasks

Each supports: GET (list), POST (create), GET/:id (retrieve), PUT/:id (update), DELETE/:id (delete)

## Common Pitfalls and Solutions

### Backend

- **Migration conflicts**: Always pull latest migrations before creating new ones
- **Circular imports**: Keep serializers and models in separate files
- **Missing type hints**: Use mypy or IDE type checking to catch missing hints
- **Missing docstrings**: All functions/classes must have docstrings

### Frontend

- **Type errors**: Run `npm run build` frequently to catch TypeScript errors
- **API URL**: Backend must be running on localhost:8000 for frontend to work
- **CORS errors**: Ensure django-cors-headers is configured in backend settings
- **Missing type annotations**: All function parameters and returns need explicit types

## Testing Guidelines

### Backend Tests

- Located in `backend/farm/tests.py`
- Test models: Creation, string representation, relationships
- Test API: List, create, retrieve, update, delete operations
- Test auto-calculated fields (e.g., harvest_date in PlantingPlan)
- Use Django's TestCase and APITestCase

### Frontend Tests

- Located in `frontend/src/__tests__/`
- Test component rendering
- Test user interactions (future: add more interaction tests)
- Test API client structure
- Use Vitest and React Testing Library

## Security Considerations

- Django CSRF protection enabled
- CORS configured for localhost:5173 (development)
- No sensitive data in version control
- Admin interface protected by Django authentication
- Input validation via Django forms and DRF serializers
- SQL injection prevention via Django ORM

## Future Enhancements

- User authentication and permissions
- Production database (PostgreSQL)
- Deployment configuration
- More comprehensive frontend tests
- E2E tests with Playwright
- Additional features: irrigation tracking, harvest recording, financial planning
